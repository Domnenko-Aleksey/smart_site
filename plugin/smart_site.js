window.addEventListener('DOMContentLoaded',function(){DA.init();});DA={domain:'xn----7sbb0blzeehe.xn--p1ai',url_get_intro:'/api/get_intro_ajax',url_id_answer:'/api/get_id_answer_ajax',url_spech_answer:'/api/get_speech_answer_ajax',url_fav_get:'/api/get_fav_ajax',url_fav_set:'/api/set_fav_ajax',intro_text:'',intro_speech:'',first_start:true,open_icon:false,right:false,speech_out:false,mic_icon:false,check_icon:false,speak_icon:false,speak_icon_src:false,icons:{'arrow':'<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"><path d="M13.025 1l-2.847 2.828 6.176 6.176h-16.354v3.992h16.354l-6.176 6.176 2.847 2.828 10.975-11z"/></svg>','audio':'<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"><path d="M6 7l8-5v20l-8-5v-10zm-6 10h4v-10h-4v10zm20.264-13.264l-1.497 1.497c1.847 1.783 2.983 4.157 2.983 6.767 0 2.61-1.135 4.984-2.983 6.766l1.498 1.498c2.305-2.153 3.735-5.055 3.735-8.264s-1.43-6.11-3.736-8.264zm-.489 8.264c0-2.084-.915-3.967-2.384-5.391l-1.503 1.503c1.011 1.049 1.637 2.401 1.637 3.888 0 1.488-.623 2.841-1.634 3.891l1.503 1.503c1.468-1.424 2.381-3.309 2.381-5.394z"/></svg>','audio_off':'<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"><path d="M22 1.269l-18.455 22.731-1.545-1.269 3.841-4.731h-1.827v-10h4.986v6.091l2.014-2.463v-3.628l5.365-2.981 4.076-5.019 1.545 1.269zm-10.986 15.926v.805l8.986 5v-16.873l-8.986 11.068z"/></svg>','check':'<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"><path d="M9 21.035l-9-8.638 2.791-2.87 6.156 5.874 12.21-12.436 2.843 2.817z"/></svg>','cross':'<svg xmlns="http://www.w3.org/2000/svg" id="da_show_cross" style="width:20px;height:20px;opacity:0.5" viewBox="0 0 24 24"><path d="M23 20.168l-8.185-8.187 8.185-8.174-2.832-2.807-8.182 8.179-8.176-8.179-2.81 2.81 8.186 8.196-8.186 8.184 2.81 2.81 8.203-8.192 8.18 8.192z"/></svg>','next':'<svg xmlns="http://www.w3.org/2000/svg" style="width:50px;height:50px;opacity:0.5" viewBox="0 0 24 24"><path d="M12 0c-6.627 0-12 5.373-12 12s5.373 12 12 12 12-5.373 12-12-5.373-12-12-12zm-1.568 18.005l-1.414-1.415 4.574-4.59-4.574-4.579 1.414-1.416 5.988 5.995-5.988 6.005z"/></svg>','microphone':'<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"><path d="M16 10c0 2.209-1.791 4-4 4s-4-1.791-4-4v-6c0-2.209 1.791-4 4-4s4 1.791 4 4v6zm4-2v2c0 4.418-3.582 8-8 8s-8-3.582-8-8v-2h2v2c0 3.309 2.691 6 6 6s6-2.691 6-6v-2h2zm-7 13.03v-2.03h-2v2.03c-2.282.139-4 .744-4 1.47 0 .829 2.238 1.5 5 1.5s5-.671 5-1.5c0-.726-1.718-1.331-4-1.47z"/></svg>','pause':'<svg xmlns="http://www.w3.org/2000/svg" style="width:50px;height:50px;opacity:0.5" viewBox="0 0 24 24"><path d="M11 22h-4v-20h4v20zm6-20h-4v20h4v-20z"/></svg>','play':'<svg xmlns="http://www.w3.org/2000/svg" style="width:50px;height:50px;opacity:0.5" viewBox="0 0 24 24"><path d="M12 2c5.514 0 10 4.486 10 10s-4.486 10-10 10-10-4.486-10-10 4.486-10 10-10zm0-2c-6.627 0-12 5.373-12 12s5.373 12 12 12 12-5.373 12-12-5.373-12-12-12zm-3 18v-12l10 6-10 6z"/></svg>','prev':'<svg xmlns="http://www.w3.org/2000/svg" style="width:50px;height:50px;opacity:0.5" viewBox="0 0 24 24"><path d="M0 12c0 6.627 5.373 12 12 12s12-5.373 12-12-5.373-12-12-12-12 5.373-12 12zm7.58 0l5.988-5.995 1.414 1.416-4.574 4.579 4.574 4.59-1.414 1.416-5.988-6.006z"/></svg>','spinner':'<svg class="spinner" xmlns="http://www.w3.org/2000/svg" style="width:50px;height:50px;opacity:0.5" viewBox="0 0 24 24"><path d="M13.75 22c0 .966-.783 1.75-1.75 1.75s-1.75-.784-1.75-1.75.783-1.75 1.75-1.75 1.75.784 1.75 1.75zm-1.75-22c-1.104 0-2 .896-2 2s.896 2 2 2 2-.896 2-2-.896-2-2-2zm10 10.75c.689 0 1.249.561 1.249 1.25 0 .69-.56 1.25-1.249 1.25-.69 0-1.249-.559-1.249-1.25 0-.689.559-1.25 1.249-1.25zm-22 1.25c0 1.105.896 2 2 2s2-.895 2-2c0-1.104-.896-2-2-2s-2 .896-2 2zm19-8c.551 0 1 .449 1 1 0 .553-.449 1.002-1 1-.551 0-1-.447-1-.998 0-.553.449-1.002 1-1.002zm0 13.5c.828 0 1.5.672 1.5 1.5s-.672 1.501-1.502 1.5c-.826 0-1.498-.671-1.498-1.499 0-.829.672-1.501 1.5-1.501zm-14-14.5c1.104 0 2 .896 2 2s-.896 2-2.001 2c-1.103 0-1.999-.895-1.999-2s.896-2 2-2zm0 14c1.104 0 2 .896 2 2s-.896 2-2.001 2c-1.103 0-1.999-.895-1.999-2s.896-2 2-2z"/></svg>'},init(){DA.get_intro(function(){DA.url_id_answer='https://'+DA.domain+DA.url_id_answer;DA.url_spech_answer='https://'+DA.domain+DA.url_spech_answer;DA.url_fav_get='https://'+DA.domain+DA.url_fav_get;DA.url_fav_set='https://'+DA.domain+DA.url_fav_set;let link=DA.load_css();link.onload=()=>{DA.create_tab();DA.fav_init();}});},get_intro(callback){let form=new FormData();form.append('domain',location.host);let url='https://'+DA.domain+DA.url_get_intro;DA.ajax(url,form,function(data){DA.intro_text=data.intro_text;DA.intro_speech=data.intro_speech;callback();})},load_css(){var head=document.getElementsByTagName('head')[0];var link=document.createElement('link');link.rel='stylesheet';link.type='text/css';link.href='https://xn----7sbb0blzeehe.xn--p1ai/plugin/smart_site.css?'+Math.floor(Math.random()*1000000);link.media='all';head.appendChild(link);return link;},fav_init(){DA.check_icon.classList.remove('active');let fav_item_arr=document.getElementsByClassName('da_fav_item');let fav_del=document.getElementsByClassName('da_fav_del');for(i=0;i<fav_item_arr.length;i++){fav_item_arr[i].onclick=function(){DA.get_id_answer_ajax(this.id);};fav_del[i].onclick=function(e){this.parentNode.remove();e.stopPropagation();DA.send_favorites();};}},create_tab(){let tab='<div id="da">'+'<div id="da_left">'+'<div id="da_open_icon">'+DA.icons.microphone+'</div>'+'<div id="da_speech_container">'+'<div class="da_speech_wrap da_w1440">'+'<div id="da_mic_icon" class="da_speech_icon" title="Вкл/выкл микрофона">'+DA.icons.microphone+'</div>'+'<div id="da_check_icon" class="da_speech_icon display_none" title="Добавить в избранное">'+DA.icons.check+'</div>'+'<div id="da_speak_icon" class="da_speech_icon active" title="Вкл/выкл звук">'+DA.icons.audio+'</div>'+'<div id="da_speech_out">'+DA.intro_text+'</div>'+'</div>'+'</div>'+'<div class="da_answer_container da_w1440">'+'<div id="da_answer_content"></div>'+'</div>'+'</div>'+'<div id="da_right">'+'</div>'+'</div>';document.body.insertAdjacentHTML('afterBegin',tab);DA.open_icon=document.getElementById('da_open_icon');DA.right=document.getElementById('da_right');DA.speech_out=document.getElementById('da_speech_out');DA.mic_icon=document.getElementById('da_mic_icon');DA.check_icon=document.getElementById('da_check_icon');DA.speak_icon=document.getElementById('da_speak_icon');DA.open_icon.onclick=DA.set_active;DA.mic_icon.onclick=DA.mic_on_off;DA.check_icon.onclick=DA.set_favorites;DA.speak_icon.onclick=DA.synth_on_off;DA.speech.init();},set_active(){if(DA.first_start){DA.get_favorites();};let main_container=document.getElementById('da');DA.open_icon.classList.toggle('active');main_container.classList.toggle('active');let node_open_icon=document.getElementById('da_open_icon');if(DA.open_icon.classList.contains('active')){if(DA.first_start&&DA.speech.sn_on&&DA.intro_speech!=''){DA.speech.synthesis_start(DA.intro_speech);}else{DA.speech.recognize_start();};node_open_icon.innerHTML=DA.icons.arrow;}else{node_open_icon.innerHTML=DA.icons.microphone;DA.speech.recognize_stop();DA.speech.synthesis_stop();};if(DA.first_start){DA.first_start=false;};},mic_on_off(){if(DA.mic_icon.classList.contains('active')){DA.speech.sr_on=false;DA.speech.recognize_stop();}else{DA.speech.sr_on=true;DA.speech.recognize_start();};},synth_on_off(){if(da_speak_icon.classList.contains('active')){DA.speech.synthesis_stop();}else{DA.speech.synthesis_start();};},set_favorites(){DA.check_icon.classList.add('active');let da_answer=document.getElementById('da_answer');if(da_answer){let f_id='f_'+da_answer.dataset.id;let fav_items=document.getElementById('da_right').getElementsByClassName('da_fav_item');for(let i=0;i<fav_items.length;i++){if(fav_items[i].id==f_id){fav_items[i].remove();};};let speech_text=DA.speech_out.innerHTML;let fav_content=DA.set_favorites_html(f_id,speech_text);DA.right.insertAdjacentHTML('afterbegin',fav_content);};DA.send_favorites();DA.fav_init();},set_favorites_html(f_id,text){return'<div id="'+f_id+'" class="da_fav_item"><span class="da_fav_item_text">'+text+'</span><span class="da_fav_del">&#10006;</span></div>';},send_favorites(){let ss_cid='';if(document.cookie.indexOf("ss_cid")!=-1){let re=new RegExp("ss_cid=([a-z0-9]{32})");ss_cid=re.exec(document.cookie)[1];};let form=new FormData();let questions=[];let ids=[];let fav_container=document.getElementById('da_right');let fav_items=fav_container.getElementsByClassName('da_fav_item');let fav_items_text=fav_container.getElementsByClassName('da_fav_item_text');for(let i=0;i<fav_items.length;i++){questions.push(fav_items_text[i].innerHTML);let id=fav_items[i].id.replace('f_','');ids.push(id);};form.append('domain',location.host);form.append('ss_cid',ss_cid);form.append('questions',questions);form.append('ids',ids);DA.ajax(DA.url_fav_set,form,function(data){console.log('--- SET FAV AJAX ---');});},get_favorites(){let ss_cid='';if(document.cookie.indexOf("ss_cid")!=-1){let re=new RegExp("ss_cid=([a-z0-9]{32})");ss_cid=re.exec(document.cookie)[1];};let form=new FormData();form.append('domain',location.host);form.append('ss_cid',ss_cid);DA.ajax(DA.url_fav_get,form,function(data){console.log('--- GET FAV AJAX ---',data);if(data.ss_cid_new!=''){document.cookie="ss_cid="+data.ss_cid_new+"; path=/; expires=Tue, 20 Jan 2030 01:01:01 GMT";};for(var id in data.favorites){let fav_html=DA.set_favorites_html('f_'+id,data.favorites[id]);DA.right.insertAdjacentHTML('beforeend',fav_html);};DA.fav_init();});},get_speech_answer_ajax(speech_text,id=false){console.log('SPEECH:',speech_text);speech_text=speech_text.charAt(0).toUpperCase()+speech_text.substring(1);DA.speech_out.innerHTML=speech_text;if(document.getElementById('da_check_icon').classList.contains('display_none')){document.getElementById('da_check_icon').classList.remove('display_none');};let ss_cid='';if(document.cookie.indexOf("ss_cid")!=-1){let re=new RegExp("ss_cid=([a-z0-9]{32})");ss_cid=re.exec(document.cookie)[1];};let form=new FormData();form.append('domain',location.host);form.append('speech_text',speech_text);form.append('ss_cid',ss_cid);DA.ajax(DA.url_spech_answer,form,function(data){if(data.ss_cid_new!=''){document.cookie="ss_cid="+data.ss_cid_new+"; path=/; expires=Tue, 20 Jan 2030 01:01:01 GMT";};document.getElementById('da_answer_content').innerHTML=data.answer_content;DA.check_icon.classList.remove('active');DA.show('da_image','da_images_container');if(DA.speech.sn_on){DA.speech.synthesis_start(data.answer_synthesis);};});document.getElementById('da_answer_content').innerHTML=DA.icons.spinner;},get_id_answer_ajax(f_id){let form=new FormData();let id=f_id.replace('f_','');form.append('domain',location.host);form.append('id',id);DA.ajax(DA.url_id_answer,form,function(data){document.getElementById('da_answer_content').innerHTML=data.answer_content;DA.check_icon.classList.remove('active');DA.show('da_image','da_images_container');if(DA.speech.sn_on){DA.speech.synthesis_start(data.answer_synthesis);};});}};DA.speech={sr:false,sn:false,sr_on:true,sn_on:true,init(){if(!DA.speech.sr){DA.speech.sr=new(window.SpeechRecognition||window.webkitSpeechRecognition||window.mozSpeechRecognition||window.msSpeechRecognition)();DA.speech.sr.lang="ru-RU";};},recognize_start(){if(window.speechSynthesis==undefined){alert('Чтение речи не поддерживается в данном браузере');return;};DA.mic_icon.classList.add('active');DA.speech.sr_on=true;DA.speech.sr.start();DA.speech.sr.onresult=function(event){let speech_text=event.results[0][0].transcript;DA.get_speech_answer_ajax(speech_text);};DA.speech.sr.onend=()=>{if(DA.speech.sr_on){DA.speech.sr.start();};};},synthesis_start(text){DA.speech.sr.abort();DA.speech.sn_on=true;DA.speak_icon.classList.add('active');DA.speak_icon.innerHTML=DA.icons.audio;DA.speech.sn=window.speechSynthesis;DA.speech.recognize_stop();let utterance=new SpeechSynthesisUtterance(text);DA.speech.sn.speak(utterance);utterance.onend=()=>{if(DA.open_icon.classList.contains('active')){DA.speech.recognize_start();};};},recognize_stop(){DA.speech.sr_on=false;DA.speech.sr.abort();DA.mic_icon.classList.remove('active');},synthesis_stop(){DA.speech.sn_on=false;if(DA.speech.sn){DA.speech.sn.cancel();};DA.speak_icon.classList.remove('active');DA.speak_icon.innerHTML=DA.icons.audio_off;}};DA.ajax=function(url,form,callback){let req=new XMLHttpRequest();req.onreadystatechange=()=>{if(req.readyState==4&&req.status==200){let data=JSON.parse(req.responseText);if(data.answer=='success'){callback(data);}else{alert(data.message);};};};req.open('post',url,true);req.send(form);};DA.show=function(_class,_id){if(!document.getElementById(_id)){return;};let obj=new DA_show(_class,_id);run(obj);function run(){for(let i=0;i<obj.sum;i++){obj.img_arr[i].style.cursor='url(https://xn----7sbb0blzeehe.xn--p1ai/smart-site/templates/plugin/images/lupa.png), auto';obj.img_arr[i].onclick=(e)=>{DA.speech.recognize_stop();DA.speech.synthesis_stop();if(!obj.bg){obj.bg=document.createElement('div');obj.bg.id='da_show_black';document.body.insertBefore(obj.bg,document.body.children[0]);obj.bg.onclick=function(){obj.del();obj.bg=false;obj.image=false;};};obj.output(e.target);obj.image.onclick=function(e){e.stopPropagation();};document.getElementById('da_show_nav_left').onclick=(e)=>{e.stopPropagation();obj.stop();obj.prev();};document.getElementById('da_show_nav_play').onclick=(e)=>{e.stopPropagation();play('button');function play(_but=false){if(_but=='button'){if(!obj.timer){document.getElementById('da_show_nav_play').removeChild(document.getElementById('da_show_nav_play').lastChild);document.getElementById('da_show_nav_play').insertAdjacentHTML('afterbegin',DA.icons.pause);}else{obj.stop();return;};};obj.next();obj.timer=setTimeout(function(){requestAnimationFrame(play);},obj.interval);};};document.getElementById('da_show_nav_right').onclick=(e)=>{e.stopPropagation();obj.stop();obj.next();};};};};};class DA_show{constructor(_class,_id){this.container=document.getElementById(_id);this.img_arr=this.container.getElementsByClassName(_class);this.sum=this.img_arr.length;this.bg=false;this.wrap=false;this.image=false;this.interval=2000;this.nav_play=false;this.num=false;this.timer=false;};output(img){let img_out=document.createElement('img');img_out.src=img.src;img_out.id='da_show_image';for(let i=0;i<this.sum;i++){if(typeof this.img_arr[i]=='undefined'){continue;};if(img.src==this.img_arr[i].src){this.num=i;};};this.wrap=document.createElement('div');this.wrap.id='da_show_wrap';this.bg.insertAdjacentElement('afterbegin',this.wrap);this.image=this.wrap.insertAdjacentElement('afterbegin',img_out);this.wrap.insertAdjacentHTML('afterbegin',DA.icons.cross);let nav_left=document.createElement('div');nav_left.id='da_show_nav_left';this.wrap.insertAdjacentElement('afterbegin',nav_left);nav_left.insertAdjacentHTML('afterbegin',DA.icons.prev);let nav_right=document.createElement('div');nav_right.id='da_show_nav_right';this.wrap.insertAdjacentElement('beforeend',nav_right);nav_right.insertAdjacentHTML('afterbegin',DA.icons.next);let nav_play=document.createElement('div');nav_play.id='da_show_nav_play';this.wrap.insertAdjacentElement('afterbegin',nav_play);nav_play.insertAdjacentHTML('afterbegin',DA.icons.play);};prev(){this.num--;if(this.num<0){this.num=this.img_arr.length-1;};this.image.src=this.img_arr[this.num].src;};next(){this.num++;if(this.num>(this.sum-1)){this.num=0;};this.image.src=this.img_arr[this.num].src;};stop(){document.getElementById('da_show_nav_play').removeChild(document.getElementById('da_show_nav_play').lastChild);document.getElementById('da_show_nav_play').insertAdjacentHTML('afterbegin',DA.icons.play);clearTimeout(this.timer);this.timer=false;};del(e){this.stop();document.body.removeChild(document.getElementById('da_show_black'));};};